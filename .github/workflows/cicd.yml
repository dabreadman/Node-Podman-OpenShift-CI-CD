name: CI/CD

env:
  # Using Quay.io
  CONTAINER: docker
  REGISTRY: quay.io
  REGISTRY_USERNAME: dabreadman
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  APP_NAME: "covid-app"
  TAG: ""

  # Application environment variables
  VUE_APP_COVIDAPIKEY: ${{ secrets.VUE_APP_COVIDAPIKEY }}
  VUE_APP_POPULATIONAPIKEY: ${{ secrets.VUE_APP_POPULATIONAPIKEY }}

on:
  push:
    branches:
      - main
    paths:
      - "covid-vue-app"
      - ".github/workflows"
  pull_request:
  workflow_dispatch:

jobs:
  dev-deployment:
    name: Build and deploy to OpenShift Dev
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./covid-vue-app
    environment: development

    steps:
      - uses: actions/checkout@v2

      - name: Determine app name
        if: env.APP_NAME == ''
        run: |
          echo "APP_NAME=$(basename $PWD)" | tee -a $GITHUB_ENV

      - name: Determine tag by version
        if: env.TAG == ''
        run: |
          echo "TAG=$(jq -r .version package.json)" | tee -a $GITHUB_ENV

      - name: Podman Layer Caching
        uses: dabreadman/action-docker-layer-caching@vb.t.1
        with:
          container: ${{ env.CONTAINER }}
          key: "test"

      - name: Build image, run lint/test
        run: ${{ env.CONTAINER }} build . --file Dockerfile --build-arg VUE_APP_COVIDAPIKEY=${{ env.VUE_APP_COVIDAPIKEY }} --build-arg VUE_APP_POPULATIONAPIKEY=${{ env.VUE_APP_POPULATIONAPIKEY }} --tag ${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${{ env.APP_NAME }}:${{ env.TAG }}


